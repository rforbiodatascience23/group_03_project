---
title: "Describe data"
format: html
editor: visual
---

## Setup

Loading required packages

```{r}
#| message: false
library("tidyverse")
library("table1")
library("webshot")
```

Loading the cleaned data.

```{r}
#| message: false
dat_clean <- read_tsv("../data/02_dat_clean.tsv")
```

## Data describtion

The barplot below shows the number of males and females for each patient group.

```{r}
# Define settings for the plot
female_sign = intToUtf8(9792)
male_sign = intToUtf8(9794)
sign_size = 10
bar_width = 0.75

# Compute the numbers of females and males within each patient group 
# (used for plotting venus and mars sign)
groups <- dat_clean |> 
  group_by(gender,
           disease_state) |> 
  summarize(n = n())

# Plot the results
barplot_patient_group <- ggplot(data = dat_clean,
                                mapping = aes(x = disease_state,
                                              fill = disease_state,
                                              alpha = gender)) +
  geom_bar(width = bar_width,
           position = "dodge") +
  scale_fill_manual(
    values = c("HIV" = "royalblue", 
               "HIV/TB" = "tomato")
  ) +
  scale_alpha_manual(values = c("Male" = 0.6,
                                "Female" = 0.9)) +
  annotate("text", 
           x = 1:2-bar_width/4, 
           y = groups$n[1:2] + 2, 
           label = female_sign, 
           size = sign_size) +
  annotate("text", 
           x = 1:2+bar_width/4,
           y = groups$n[3:4] + 2, 
           label = male_sign, 
           size = sign_size) +
  theme_minimal() + 
  labs(
    x = "Disease state",
    y = "Cases",
    fill = "Gender",
    title = str_c("Distribution of males and females for HIV mono-infected and HIV/TB",
                  "\n",
                  "co-infected patients"),
    caption = "Data from Dawany et al. (2014)"
  ) +
  theme(legend.position = "none")

ggsave("../results/barplot_patient_group.png", plot = barplot_patient_group)
show(barplot_patient_group)
```

The above figur can also be summarized in a table. 

```{r}
summary_table <- dat_clean |>
  mutate(Gender = factor(gender),
         Disease = factor(disease_state)) |> 
  table1(x = formula(~ Gender | Disease))
show(summary_table)
```

## NORMALIZATION 

This is some code for normalization. It should be modified and go in augment. 

```{r}
expr_data <- dat_clean |> 
  select(starts_with("ILMN"))
meta_data <- dat_clean |> 
  select(-starts_with("ILMN"))

expr_data <- normalize.quantiles(as.matrix(t(expr_data)), keep.names = TRUE)
#expr_data <- log2(expr_data)
expr_data <- as_tibble(log2(t(expr_data)))

norm_data <- bind_cols(meta_data, expr_data)

norm_data |> 
  write_tsv(file = "../data/04_dat_aug_alternative.tsv")
```

This was just a way to briefly see the effect and is not expected to be included in the final code:

```{r}
dat_clean |> 
  pivot_longer(cols = starts_with("ILMN"),
               names_to = "gene_id",
               values_to = "expression") |> 
  mutate(logtrans = log2(expression)) |> 
  ggplot(mapping = aes(x = geo_accession,
                       y = logtrans)) +
  geom_boxplot() +
  theme_minimal()
```

```{r}
norm_data |> 
  pivot_longer(cols = starts_with("ILMN"),
               names_to = "gene_id",
               values_to = "expression") |> 
  ggplot(mapping = aes(x = geo_accession,
                       y = expression)) +
  geom_boxplot() +
  theme_minimal()
```

