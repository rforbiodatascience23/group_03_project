---
title: "01_load.qmd"
format: html
editor: visual
---

## Loading data

This document will load the data from Gene Expression Omnibus. Furthermore, the file will export the data to a tsv-file.

### Loading required packages

```{r}
#| message: false
library("tidyverse")
library("dplyr")
library("stringr")
library("GEOquery")
```

Note: Instruction of how to install the package GEOquery can be found here *https://bioconductor.org/packages/release/bioc/html/GEOquery.html*

### Load data

In the following, the directory of the data is defined along with the location of the original data.

```{r}
#| label: Set up
dest_dir <- "../data/"
raw_dir <- str_c(dest_dir, "_raw")
count_file <- "GSE50834_non-normalized.txt.gz"
meta_file <- "GSE50834_series_matrix.txt.gz"
geo <- "GSE50834"

# Create data folder if not already existing
if( !dir.exists(raw_dir) ){
  dir.create(path = raw_dir,
             recursive = TRUE)
}

```

The count-data, containing patient-ID's and gene counts, is downloaded and stored in raw-data directory.

```{r}
#| label: Load count-data
if( !file.exists(str_c(raw_dir, count_file, sep = "/")) ){
  getGEOSuppFiles(GEO = geo,
                  makeDirectory = FALSE,
                  baseDir = raw_dir,
                  fetch_files = TRUE,
                  filter_regex = "txt")
}

count_data <- read.table(file = str_c(raw_dir, count_file, sep = "/"),
                         sep = "\t",
                         header = TRUE)
```

The meta-data, containing patient-ID's patient information, is downloaded and stored in raw-data directory.

```{r}
#| label: Load meta-data
if( !file.exists(str_c(raw_dir, meta_file, sep = "/")) ){
  meta_data <- getGEO(GEO = geo,
                      destdir = raw_dir,
                      GSEMatrix = TRUE)
}

meta_data <- pData(phenoData(meta_data[[1]]))

```

### Save data as tsv files

In the following the count-data and the meta-data are saved as .tsv-files

```{r}
#| label: Write tsv-files

count_data |> 
  write_tsv(file = str_c(dest_dir, "01_dat_load_count.tsv"))

meta_data |> 
  write_tsv(file = str_c(dest_dir, "01_dat_load_meta.tsv"))

meta_data |> 
  write_tsv(file = "../data/01_dat_load_meta.tsv")
```
