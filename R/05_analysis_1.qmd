---
title: "Analysis 1"
format: html
editor: visual
---

## Setup

Loading required packages.

```{r}
#| label: 05_Load packages
#| message: false
library('tidyverse')
library('broom')
```

Load the augment data.

```{r}
#| label: 05_Load data
#| message: false
dat_aug <- read_tsv(file = "../data/04_dat_aug.tsv")
```

## Principal Component Analysis

In the following a Principal Component Analysis (PCA) is carried out on the augment data.

```{r}
#| label: 05_PCA 
pca_fit <- dat_aug |> 
  select(starts_with("ILMN")) |>
  prcomp()

pca_fit_aug <- pca_fit |> 
  augment(dat_aug)
```

### Plot Principal Components

The Principal Components (PC) of the PCA is plotted against each other.

First, the first PC is plotted against the second PC.

```{r}
#| label: 05_Plot PC1 vs PC2
scatter_pc1_pc2 <- ggplot(pca_fit_aug,
       mapping = aes(x = .fittedPC1, y = .fittedPC2, color = disease_state, shape = gender)) + 
  geom_point() +
  scale_color_manual(
    values = c("HIV" = "royalblue", "HIV/TB" = "tomato")
  ) +
  labs(
    x = "PC1",
    y = "PC2",
    color = "Disease state",
    shape = "Gender"
  ) +
  theme_minimal()
ggsave("../results/scatter_pc1_pc2.png", plot = scatter_pc1_pc2)
show(scatter_pc1_pc2)
```
From above it is seen, that PC1 to some extend is able to distinguis between HIV/TB co-infected and HIV mono-infected patients, while PC2 show no prominent pattern related to infection or gender.

### Plot the Variance Explained

The variance explained by each PC is plotted.

```{r}
#| label: 05_Plot variance explained
pca_fit_eigen <- pca_fit |> 
  tidy(matrix = "eigenvalues")

var_explained <- ggplot(pca_fit_eigen,
       mapping = aes(x = PC, y = percent)) +
  geom_col(fill = "royalblue") +
  geom_smooth(mapping = aes(x = PC, y = cumulative), method = "loess", formula = y ~ x, color = "royalblue") +
  geom_hline(yintercept = 0.95) +
  annotate("text", x=10, y=0.93, label="95% variance explained") +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))
  ) +
  labs(
    y = "Variance explained"
  ) +
  theme_minimal()
ggsave("../results/var_explained.png", plot = var_explained)
show(var_explained)
```
From the variance explained plot it is seen, that 35 PCs are required to explain 95% of the variance in the data. 