---
title: "Analysis 1"
format: html
editor: visual
---

## Setup

Loading required packages.

```{r}
#| label: Load packages
#| message: false
library('tidyverse')
library('broom')
library('lubridate')
```

Load the augment data.

```{r}
#| label: Load data
#| message: false
dat_aug <- read_tsv(file = "../data/04_dat_aug.tsv")
```

## Principal Component Analysis

In the following a Principal Component Analysis (PCA) is carried out on the augment data.

```{r}
#| label: PCA 
pca_fit <- dat_aug |> 
  select(starts_with("ILMN")) |>
  prcomp()

pca_fit_aug <- pca_fit |> 
  augment(dat_aug)
```

### Plot Principal Components

The Principal Components (PC) of the PCA is plotted against each other.

First, the first PC is plotted against the second PC.

```{r}
#| label: Plot PC1 vs PC2
scatter_pc1_pc2 <- ggplot(pca_fit_aug,
       mapping = aes(x = .fittedPC1, y = .fittedPC2, color = gender, shape = disease_state)) + 
  geom_point() +
  scale_color_manual(
    values = c("Male" = "royalblue", "Female" = "tomato")
  ) +
  labs(
    x = "PC1",
    y = "PC2",
    color = "Gender",
    shape = "Disease state"
  ) +
  theme_minimal()
ggsave("../results/scatter_pc1_pc2.png", plot = scatter_pc1_pc2)
show(scatter_pc1_pc2)
```

Secondly, the second PC is plotted against the third PC.

```{r}
#| label: Plot PC2 vs PC3
scatter_pc2_pc3 <- ggplot(pca_fit_aug,
       mapping = aes(x = .fittedPC2, y = .fittedPC3, color = gender, shape = disease_state)) + 
  geom_point() +
  scale_color_manual(
    values = c("Male" = "royalblue", "Female" = "tomato")
  ) +
  labs(
    x = "PC2",
    y = "PC3",
    color = "Gender",
    shape = "Disease state"
  ) +
  theme_minimal()
ggsave("../results/scatter_pc2_pc3.png", plot = scatter_pc2_pc3)
show(scatter_pc2_pc3)
```

### Plot the Rotation Matrix

The PCA is rotated to change the direction of the PCs.

```{r}
#| label: Rotated PCA
pca_fit_rotation <- pca_fit |> 
  tidy(matrix = "rotation") |> 
  pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value")
```

The rotated PCs are plotted against each other.

First, the first rotated PC is plotted against the second rotated PC.

```{r}
#| label: Plot rotated PC1 vs PC2
rotation_pc1_pc2 <- ggplot(pca_fit_rotation,
       mapping = aes(x = PC1, y = PC2)) +
  geom_segment(xend = 0, yend = 0, arrow = arrow()) +
  geom_text(
    mapping = aes(label = column),
    hjust = 1, 
    color = "royalblue", size = 2
  ) +
  labs(
    title = "Rotation matrix"
  ) +
  theme_minimal()
ggsave("../results/rotation_pc1_pc2.png", plot = rotation_pc1_pc2)
show(rotation_pc1_pc2)
```
Second, the second rotated PC is plotted against the third rotated PC.

```{r}
#| label: Plot rotated PC2 vs PC3
rotation_pc2_pc3 <- ggplot(pca_fit_rotation,
       mapping = aes(x = PC2, y = PC3)) +
  geom_segment(xend = 0, yend = 0, arrow = arrow()) +
  geom_text(
    mapping = aes(label = column),
    hjust = 1, 
    color = "royalblue", size = 2
  ) +
  labs(
    title = "Rotation matrix"
  ) +
  theme_minimal()
ggsave("../results/rotation_pc2_pc3.png", plot = rotation_pc2_pc3)
show(rotation_pc2_pc3)

```

### Plot the Variance Explained

The variance explained by each PC is plotted.

```{r}
#| label: Plot variance explained
pca_fit_eigen <- pca_fit |> 
  tidy(matrix = "eigenvalues")

var_explained <- ggplot(pca_fit_eigen,
       mapping = aes(x = PC, y = percent)) +
  geom_col(fill = "royalblue") +
  geom_smooth(mapping = aes(x = PC, y = cumulative), method = "loess", formula = y ~ x, color = "royalblue") +
  geom_hline(yintercept = 0.95) +
  annotate("text", x=38, y=0.93, label="95% variance explained") +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))
  ) +
  labs(
    y = "Variance explained"
  ) +
  theme_minimal()
ggsave("../results/var_explained.png", plot = var_explained)
show(var_explained)
```
